name: Deploy to Server

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: art-design-frontend
      CONTAINER_NAME: art-design-frontend
      SERVER_IP: ${{ secrets.SERVER_IP }}
      SSH_USER:  ${{ secrets.SSH_USER }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
    steps:
      # æ‹‰å–ä»£ç 
      - name: Check out repository code
        uses: actions/checkout@v4

      # âœ… æ¨èä½¿ç”¨ Node 20ï¼ˆLTSï¼‰ï¼Œæ›´ç¨³å®š
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # âœ… æ­£ç¡®å®‰è£… pnpm å¹¶æ·»åŠ åˆ° PATH
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8 # æˆ– 10.8.0ï¼Œä¿æŒä¸€è‡´å³å¯
          run_install: false  # â—ä¸è¦è®©å®ƒè‡ªåŠ¨å®‰è£…ä¾èµ–

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Vue Application
        run: pnpm run build


      # æ¸…ç†æ—§å®¹å™¨å’Œé•œåƒ
      - name: Cleanup existing Docker container and image
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ” Checking and cleaning existing Docker container and image..."

            # ========= 1. ç§»é™¤æ—§å®¹å™¨ ==========
            CONTAINER_ID=$(docker ps -a -q --filter "name=^/${{ env.CONTAINER_NAME }}$")

            if [ -n "$CONTAINER_ID" ]; then
              echo "ğŸ›‘ Removing container: ${{ env.CONTAINER_NAME }} ($CONTAINER_ID)"
              docker rm -f "$CONTAINER_ID" || true
              echo "âœ… Container removed."
            else
              echo "â„¹ï¸ No container named ${{ env.CONTAINER_NAME }} found."
            fi

            # ========= 2. ç§»é™¤æ—§é•œåƒ ==========
            IMAGE_ID=$(docker images -q ${{ env.IMAGE_NAME }}:latest)

            if [ -n "$IMAGE_ID" ]; then
              echo "ğŸ§¹ Removing image: ${{ env.IMAGE_NAME }}:latest ($IMAGE_ID)"
              docker rmi -f "$IMAGE_ID" || true
              echo "âœ… Image removed."
            else
              echo "â„¹ï¸ No image named ${{ env.IMAGE_NAME }}:latest found."
            fi

      # ä¸Šä¼ æ„å»ºäº§ç‰©å’Œ Dockerfile åˆ°æœåŠ¡å™¨
      - name: Upload artifact to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          source: "dist,Dockerfile,nginx.conf"
          target: "/home/docker-images/${{ env.IMAGE_NAME }}"

      # æ„å»ºé•œåƒå¹¶è¿è¡Œå®¹å™¨
      - name: Build Docker image and run container
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd /home/docker-images/${{ env.IMAGE_NAME }}

            docker build -t ${{ env.IMAGE_NAME }}:latest .

            docker run -d \
              --network docker-compose_app-net \
              --name ${{ env.CONTAINER_NAME }} \
              -v /etc/letsencrypt/live/www.soyorinlove.cn/fullchain.pem:/app/certs/fullchain.pem \
              -v /etc/letsencrypt/live/www.soyorinlove.cn/privkey.pem:/app/certs/privkey.pem \
              -e SSL_CERT_PATH=/app/certs/fullchain.pem \
              -e SSL_KEY_PATH=/app/certs/privkey.pem \
              --restart unless-stopped \
              ${{ env.IMAGE_NAME }}:latest
